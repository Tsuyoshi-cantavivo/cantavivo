{% extends 'admin_base.html' %}

{% block title %}å‡ºæ¼”æƒ…å ± ç®¡ç†ç”»é¢{% endblock %}

{% block content %}
<div class="flex font-sans">
  {% include 'admin_menu.html' %}

  <main class="ml-64 w-full px-6 py-8">
    <h2 class="text-2xl font-semibold mb-6 text-center">å‡ºæ¼”æƒ…å ± ç®¡ç†ç”»é¢</h2>

    <form id="concertForm" enctype="multipart/form-data" class="space-y-4 max-w-2xl mx-auto">
      <div>
        <label class="block mb-1 font-medium">ã‚¿ã‚¤ãƒˆãƒ«</label>
        <input type="text" name="title" required class="w-full border rounded px-3 py-2">
      </div>
      <div>
        <label class="block mb-1 font-medium">æ—¥ä»˜</label>
        <input type="date" name="date" required class="w-full border rounded px-3 py-2">
      </div>
      <div>
        <label class="block mb-1 font-medium">é–‹æ¼”æ™‚é–“</label>
        <input type="text" name="time" required class="w-full border rounded px-3 py-2" placeholder="ä¾‹ï¼š15:00">
      </div>
      <div>
        <label class="block mb-1 font-medium">å ´æ‰€</label>
        <input type="text" name="location" required class="w-full border rounded px-3 py-2">
      </div>
      <div>
        <label class="block mb-1 font-medium">è©³ç´°</label>
        <textarea name="description" required class="w-full border rounded px-3 py-2"></textarea>
      </div>
      <div>
        <label class="block mb-1 font-medium">ãƒãƒ©ã‚·ç”»åƒã¾ãŸã¯PDF</label>
        <input type="file" name="image" accept="image/*,application/pdf" class="w-full">
      </div>
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded">è¿½åŠ </button>
    </form>

    <div id="message" class="mt-6 text-center text-green-600 font-semibold hidden">å‡ºæ¼”æƒ…å ±ã‚’è¿½åŠ ã—ã¾ã—ãŸ</div>

    <hr class="my-10 max-w-2xl mx-auto">
    <div class="max-w-2xl mx-auto">
      <h3 class="text-lg font-semibold mb-4">ç™»éŒ²æ¸ˆã¿å‡ºæ¼”æƒ…å ±</h3>
      <ul id="concertList" class="space-y-4"></ul>
    </div>
  </main>
</div>

<script>
  async function loadConcerts() {
    const res = await fetch("/concerts");
    const html = await res.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");
    const blocks = doc.querySelectorAll("section .space-y-6 > div");
    const list = document.getElementById("concertList");
    list.innerHTML = "";
    blocks.forEach((el, i) => {
      const title = el.querySelector("h2").innerText;
      const li = document.createElement("li");
      li.className = "flex justify-between items-center border p-3 rounded";
      li.innerHTML = `
        <span>${title}</span>
        <button onclick="deleteConcert(${i})" class="text-red-600 hover:underline">ğŸ—‘ å‰Šé™¤</button>
      `;
      list.appendChild(li);
    });
  }

  async function deleteConcert(index) {
    if (!confirm("ã“ã®å‡ºæ¼”æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    const res = await fetch(`/delete_concert/${index}`, { method: "POST" });
    const result = await res.json();
    if (result.status === "success") {
      loadConcerts();
    } else {
      alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + result.message);
    }
  }

  document.getElementById('concertForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const res = await fetch('/add_concert', {
      method: 'POST',
      body: formData
    });
    const result = await res.json();
    if (result.status === 'success') {
      document.getElementById('message').classList.remove('hidden');
      form.reset();
      loadConcerts();
    } else {
      alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  });

  window.onload = loadConcerts;
</script>
{% endblock %}